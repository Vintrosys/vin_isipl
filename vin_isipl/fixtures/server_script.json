[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-18 12:46:17.702855",
  "module": null,
  "name": "Late Entry Calculation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "frappe.msgprint(\"Server Script Triggered\")\n\ntotal_late_hours = 0\n\nattendance_list = frappe.get_all(\n    \"Attendance\",\n    filters={\n        \"employee\": doc.employee,\n        \"attendance_date\": [\"between\", [doc.start_date, doc.end_date]],\n        \"status\": \"Present\",\n        \"late_entry\": 1  # Add this condition to filter only records marked as Late Entry\n    },\n    fields=[\"attendance_date\", \"in_time\", \"shift\", \"late_entry\"]\n)\n\nfrappe.msgprint(\"Attendance rows with Late Entry: \" + str(len(attendance_list)))\n\nfor att in attendance_list:\n\n    if not att.get(\"shift\") or not att.get(\"in_time\"):\n        continue\n\n    try:\n        shift_doc = frappe.get_doc(\"Shift Type\", att.get(\"shift\"))\n    except:\n        continue\n\n    if not shift_doc.get(\"start_time\"):\n        continue\n\n    try:\n        shift_start = frappe.utils.get_datetime(\n            f\"{att.get('attendance_date')} {shift_doc.get('start_time')}\"\n        )\n        in_dt = frappe.utils.get_datetime(att.get(\"in_time\"))\n\n        late_hours = frappe.utils.time_diff_in_hours(in_dt, shift_start)\n\n        frappe.msgprint(f\"LATE HOURS: {late_hours}\")\n\n        if late_hours > 0:\n            total_late_hours = total_late_hours + late_hours\n\n    except Exception as e:\n        frappe.msgprint(\"Error: \" + str(e))\n        continue\n\nfrappe.msgprint(\"FINAL TOTAL LATE HOURS = \" + str(total_late_hours))\n\ndoc.custom_late_entry_hours = round(total_late_hours, 2)\ndoc.custom_working_hours_shortfall = round(total_late_hours, 2)\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-20 15:07:40.623430",
  "module": "Vin Isipl",
  "name": "FCRM Comment Update",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Comment",
  "script": "if doc.reference_doctype == \"CRM Deal\" and doc.reference_name:\n    ts = doc.creation  # time of new comment\n    frappe.db.set_value(\n        \"CRM Deal\",\n        doc.reference_name,\n        \"modified\",\n        ts,\n        update_modified=False\n    )\n   \n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 13:08:48.918373",
  "module": "Vin Isipl",
  "name": "ISIPL HD Ticket Customization",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HD Ticket",
  "script": "# Set subject based on machine problem or others\nif doc.custom_machine_problem:\n    doc.subject = f\"{doc.custom_machine_problem} - {doc.ticket_type}\"\nelse:\n    doc.subject = f\"{doc.custom_others} - {doc.ticket_type}\"\n\n# Set custom_created_date from creation (Created On)\nif not doc.custom_created_date:\n    doc.custom_created_date = doc.creation\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-14 19:27:59.012816",
  "module": "Vin Isipl",
  "name": "ISIPL CRM Deal Customization",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "CRM Deal",
  "script": "doc.deal_owner = frappe.db.get_value(\"CRM Organization\",doc.organization,\"custom_sales_person\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-14 19:44:34.214967",
  "module": "Vin Isipl",
  "name": "HD Ticket Comment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Comment",
  "script": "# Only run for HD Ticket comments\nif doc.reference_doctype == \"HD Ticket\" and doc.comment_type == \"Comment\":\n\n    # ------------------------------------\n    # 1. Build your updated final HTML again\n    # ------------------------------------\n    html_rows = []\n    ticket = frappe.get_doc(\"HD Ticket\", doc.reference_name)\n\n    for row in ticket.custom_test_hd:\n        html_rows.append(\n            f'''\n            <li data-list=\"ordered\">\n                <span class=\"ql-ui\" contenteditable=\"false\"></span>\n                <span style=\"color: rgb(0, 102, 204);\">{row.name1}</span>\n            </li>\n            '''\n        )\n\n    final_html = f'''\n    <div class=\"ql-editor read-mode\">\n        <ol>\n            {''.join(html_rows)}\n        </ol>\n    </div>\n    '''\n\n    # ------------------------------------\n    # 2. Update Comment content\n    # ------------------------------------\n    frappe.db.set_value(\"Comment\", doc.name, \"content\", final_html)\n\n    # ------------------------------------\n    # 3. Create HD Ticket Comment\n    # ------------------------------------\n    hd_comment = frappe.get_doc({\n        \"doctype\": \"HD Ticket Comment\",\n        \"reference_ticket\": doc.reference_name,\n        \"comment_id\": doc.name,\n        \"commented_by\": doc.comment_email or doc.owner,\n        \"content\": final_html\n    }).insert(ignore_permissions=True)\n\n    # ------------------------------------\n    # 4. Link HD Ticket Comment back to Comment\n    # ------------------------------------\n    frappe.db.set_value(\n        \"Comment\",\n        doc.name,\n        \"custom_hd_comment_id\",\n        hd_comment.name\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-14 19:28:07.775126",
  "module": "Vin Isipl",
  "name": "Hd Customer Creation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "if not frappe.db.get_value(\"HD Customer\", doc.customer_name):\n    frappe.get_doc(dict(doctype = 'HD Customer',customer_name = doc.customer_name)).insert()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-14 19:23:51.863692",
  "module": "Vin Isipl",
  "name": "command update",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HD Ticket",
  "script": "# Build HTML rows\nhtml_rows = [\n    f\"\"\"\n    <li data-list=\"ordered\">\n        <span class=\"ql-ui\" contenteditable=\"false\"></span>\n        <span style=\"color: rgb(0, 102, 204);\">{row.machine_name}</span>\n    </li>\n    \"\"\"\n    for row in doc.custom_machine_type_list\n]\n\n# Heading + list\nfinal_html = f\"\"\"\n<div class=\"ql-editor read-mode\">\n    <span style=\"font-weight: 600;\">Machine Type</span><br><br>\n    <ol>\n        {''.join(html_rows)}\n    </ol>\n</div>\n\"\"\"\n\n# Check if existing comment exists\nexisting_comment = frappe.db.get_value(\n    \"Comment\",\n    {\n        \"reference_doctype\": doc.doctype,\n        \"reference_name\": doc.name,\n        \"comment_type\": \"Comment\",\n    },\n    \"name\"\n)\n\nif existing_comment:\n    comment_doc = frappe.get_doc(\"Comment\", existing_comment)\n    comment_doc.content = final_html\n    comment_doc.save(ignore_permissions=True)\nelse:\n    frappe.get_doc({\n        \"doctype\": \"Comment\",\n        \"comment_type\": \"Comment\",\n        \"reference_doctype\": doc.doctype,\n        \"reference_name\": doc.name,\n        \"content\": final_html\n    }).insert(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 }
]